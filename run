#!/bin/bash

# This config file for setting up SSH and Docker
set -e  # Exit immediately if any command returns a non-zero exit status
echo "Begin, you have to be sudo"

# Update system packages
sudo apt update -y && sudo apt upgrade -y

# Install openssh-server
sudo apt install openssh-server -y

# Modify SSH configuration for public key authentication only
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak  # Backup the original file
sudo sed -i 's/#Port 22/Port 22/' /etc/ssh/sshd_config  # Ensure Port 22 is enabled
sudo sed -i 's/#PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config  # Disable root login
sudo sed -i 's/#PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config  # Disable password authentication
sudo sed -i 's/#PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config  # Enable pubkey authentication
sudo sed -i 's/#ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/' /etc/ssh/sshd_config  # Disable other auth methods

# Optionally, allow all users to connect (can be restricted to specific users later)
sudo sed -i '/^#AllowUsers/ c\AllowUsers *' /etc/ssh/sshd_config

# Restart SSH to apply changes
sudo systemctl restart sshd

# Install UFW and configure firewall
sudo apt install ufw -y

# Allow SSH through the firewall
sudo ufw allow ssh
sudo ufw allow 22/tcp
# Set UFW to allow all incoming and outgoing traffic
sudo ufw default allow incoming
sudo ufw default allow outgoing
# Enable firewall
sudo ufw enable

# Check UFW status
sudo ufw status verbose

# Add public key to authorized_keys for the current user
mkdir -p ~/.ssh
touch ~/.ssh/authorized_keys
echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAzJNGvpR1k2x9SWe05P3eL6TuSUaiMi4DzTo3mzyL66 alirami120@hotmail.fr" >> ~/.ssh/authorized_keys

# Set proper permissions
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys

echo "SSH setup complete. You can now use public key authentication to log in."



echo "Strat with docker"


echo "this is for all conflicting packages "
sudo apt remove $(dpkg --get-selections docker.io docker-compose docker-doc podman-docker containerd runc | cut -f1)

# Add Docker's official GPG key:
sudo apt update
sudo apt install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
sudo tee /etc/apt/sources.list.d/docker.sources <<EOF
Types: deb
URIs: https://download.docker.com/linux/debian
Suites: $(. /etc/os-release && echo "$VERSION_CODENAME")
Components: stable
Signed-By: /etc/apt/keyrings/docker.asc
EOF


sudo apt update -y && sudo apt upgrade -y



sudo apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

sudo systemctl status docker

sudo systemctl start docker

